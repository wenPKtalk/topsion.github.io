
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Summary">
    <title>Archives - Summary</title>
    <meta name="author" content="Topsion">
    
    
    
    <script type="application/ld+json">{}</script>
    <meta name="description" content="The whole problem with the world is that fools and fanatics are always so certain of themselves, and wiser people so full of doubts.(这个世界的问题在于聪明人充满疑惑而傻子却坚信不疑)">
<meta property="og:type" content="blog">
<meta property="og:title" content="Summary">
<meta property="og:url" content="http://example.com/archives/index.html">
<meta property="og:site_name" content="Summary">
<meta property="og:description" content="The whole problem with the world is that fools and fanatics are always so certain of themselves, and wiser people so full of doubts.(这个世界的问题在于聪明人充满疑惑而傻子却坚信不疑)">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Topsion">
<meta name="twitter:card" content="summary">
    
    
        
    
    
        <meta property="og:image" content="http://example.com/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-6dpwtzkuy2ssu5caqdke8z8huv9meemlfuywd7y7khvuwaixxg3c6cqt7fac.min.css">

    <!--STYLES END-->
    

    

    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Summary
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Topsion</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Fullstack Developer</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="Search"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/wenPKtalk"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://stackoverflow.com/users/15967860/topsion"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Stack Overflow"
                        >
                        <i class="sidebar-button-icon fab fa-stack-overflow" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Stack Overflow</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/feed/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2024/12/17/The-meaning-of-parameters-in-java-ThreadPoolExecutor/"
                            aria-label=": The meaning of parameters in java ThreadPoolExecutor"
                        >
                            The meaning of parameters in java ThreadPoolExecutor
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2024-12-17T14:45:54+00:00">
	
		    Dec 17, 2024
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Java/">Java</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>corePoolSize: the number of threads to keep in the pool, even if they are idle, unless allowCoreThreadTimeOut is set<br>maximumPoolSize: the maximum number of threads to allow in the pool keepAliveTime when the number of threads is greater than the core, this is the maximum time that excess idle threads will wait for new tasks before terminating.<br>unit : the time unit for the keepAliveTime argument<br>workQueue: the queue to use for holding tasks before they are executed. This queue will hold only the Runnable tasks submitted by the execute method.<br>handler: the handler to use when execution is blocked because the thread bounds and queue capacities are reache</p>
<ol>
<li>corePoolSize（核心线程数）</li>
</ol>
<p>线程池中会始终保持的最小线程数<br>即使这些线程处于空闲状态，也不会被销毁（除非设置了allowCoreThreadTimeOut为true）<br>这些线程响应速度最快，因为不需要创建新线程</p>
<ol start="2">
<li>maximumPoolSize（最大线程数）</li>
</ol>
<p>线程池允许创建的最大线程数<br>当工作队列满了，且当前线程数小于maximumPoolSize时，会创建新线程<br>超过这个数量的任务会触发拒绝策略</p>
<ol start="3">
<li>keepAliveTime（空闲线程存活时间）</li>
</ol>
<p>非核心线程空闲超过这个时间后会被销毁<br>如果allowCoreThreadTimeOut为true，核心线程也会受这个参数影响<br>用于减少资源浪费</p>
<ol start="4">
<li>unit（时间单位）</li>
</ol>
<p>keepAliveTime的时间单位<br>可以是SECONDS、MINUTES等TimeUnit枚举值</p>
<ol start="5">
<li>workQueue（工作队列）</li>
</ol>
<p>用于存放待执行的任务<br>常用队列类型：</p>
<p>ArrayBlockingQueue：有界队列<br>LinkedBlockingQueue：无界队列<br>SynchronousQueue：无缓冲的等待队列<br>PriorityBlockingQueue：优先级队列</p>
<ol start="6">
<li>handler（拒绝策略）</li>
</ol>
<p>当队列满且线程数达到maximumPoolSize时的处理策略<br>默认策略类型：</p>
<p>AbortPolicy：抛出异常（默认）<br>CallerRunsPolicy：在调用者线程执行<br>DiscardPolicy：直接丢弃<br>DiscardOldestPolicy：丢弃最早的任务</p>
<p><img src="https://github.com/wenPKtalk/wenpktalk.github.io/blob/9965ec5a6944d4a596b836cf234240e07698fa8d/source/_posts/image.png" alt="image.png"></p>
<p>planUML描述如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">title ThreadPoolExecutor执行流程</span><br><span class="line"></span><br><span class="line">skinparam backgroundColor #FFFFFF</span><br><span class="line">skinparam handwritten false</span><br><span class="line"></span><br><span class="line">start</span><br><span class="line"></span><br><span class="line">:提交新任务;</span><br><span class="line"></span><br><span class="line">if (当前线程数 &lt; 核心线程数?) then (是)</span><br><span class="line">  :创建新的核心线程;</span><br><span class="line">  :执行任务;</span><br><span class="line">else (否)</span><br><span class="line">  if (工作队列未满?) then (是)</span><br><span class="line">    :将任务放入工作队列;</span><br><span class="line">    note right</span><br><span class="line">      队列类型:</span><br><span class="line">      - ArrayBlockingQueue (有界)</span><br><span class="line">      - LinkedBlockingQueue (无界)</span><br><span class="line">      - SynchronousQueue (同步)</span><br><span class="line">      - PriorityBlockingQueue (优先级)</span><br><span class="line">    end note</span><br><span class="line">  else (否)</span><br><span class="line">    if (当前线程数 &lt; 最大线程数?) then (是)</span><br><span class="line">      :创建新的临时线程;</span><br><span class="line">      note right</span><br><span class="line">        临时线程在空闲超过</span><br><span class="line">        keepAliveTime后销毁</span><br><span class="line">      end note</span><br><span class="line">      :执行任务;</span><br><span class="line">    else (否)</span><br><span class="line">      :执行拒绝策略;</span><br><span class="line">      note right</span><br><span class="line">        拒绝策略:</span><br><span class="line">        - AbortPolicy (默认)</span><br><span class="line">        - CallerRunsPolicy</span><br><span class="line">        - DiscardPolicy</span><br><span class="line">        - DiscardOldestPolicy</span><br><span class="line">      end note</span><br><span class="line">    endif</span><br><span class="line">  endif</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">fork</span><br><span class="line">  :核心线程池;</span><br><span class="line">  note right: 保持运行</span><br><span class="line">fork again</span><br><span class="line">  :临时线程池;</span><br><span class="line">  note right: 空闲超时销毁</span><br><span class="line">fork again</span><br><span class="line">  :等待队列;</span><br><span class="line">  note right: 任务缓存</span><br><span class="line">end fork</span><br><span class="line"></span><br><span class="line">stop</span><br><span class="line"></span><br><span class="line">legend right</span><br><span class="line">  参数说明:</span><br><span class="line">  ====</span><br><span class="line">  corePoolSize: 核心线程数</span><br><span class="line">  maximumPoolSize: 最大线程数</span><br><span class="line">  keepAliveTime: 空闲线程存活时间</span><br><span class="line">  workQueue: 工作队列</span><br><span class="line">  handler: 拒绝策略</span><br><span class="line">endlegend</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
                    
                        


                    
                    
                        <p>
                            <a
                                href="/2024/12/17/The-meaning-of-parameters-in-java-ThreadPoolExecutor/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2024/09/12/OrbStack-%E5%AE%89%E8%A3%85mongo5%E9%81%87%E5%88%B0%E7%9A%84%E9%94%99%E8%AF%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"
                            aria-label=": OrbStack 安装mongo5遇到的错误和解决方法"
                        >
                            OrbStack 安装mongo5遇到的错误和解决方法
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2024-09-12T18:04:17+00:00">
	
		    Sep 12, 2024
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/devOps/">devOps</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="Macos-m2上使用OrbStack-docker-安装mongo5-0"><a href="#Macos-m2上使用OrbStack-docker-安装mongo5-0" class="headerlink" title="Macos m2上使用OrbStack docker 安装mongo5.0+"></a>Macos m2上使用OrbStack docker 安装mongo5.0+</h3><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>macOS(m2) 从 desktop-docker 切换到OrbStack，使用mongo6.0镜像利用如下docker-compose.yml启动的时候会报错</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mongo:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:6.0</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mongo</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27017:27017&quot;</span> </span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/orbDocker/mongo/configdb:/data/configdb</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/orbDocker/mongo/db:/data/db</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="string">root</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>docker-compose up</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[+] Running 0/0</span><br><span class="line"> ⠋ Network mongo_default  Creating                                                                                                                       0.1s</span><br><span class="line">[+] Running 2/2d orphan containers ([mongo-mongo-express-1]) for this project. If you removed or renamed this service in your compose file, you can run this c ✔ Network mongo_default  Created                                                                                                                        0.1s</span><br><span class="line"> ✔ Container mongo        Created                                                                                                                        0.1s</span><br><span class="line">Attaching to mongo</span><br><span class="line">mongo  |</span><br><span class="line">mongo  | WARNING: MongoDB 5.0+ requires a CPU with AVX support, and your current system does not appear to have that!</span><br><span class="line">mongo  |   see https://jira.mongodb.org/browse/SERVER-54407</span><br><span class="line">mongo  |   see also https://www.mongodb.com/community/forums/t/mongodb-5-0-cpu-intel-g4650-compatibility/116610/2</span><br><span class="line">mongo  |   see also https://github.com/docker-library/mongo/issues/485#issuecomment-891991814</span><br><span class="line">mongo  |</span><br><span class="line">mongo  | /usr/local/bin/docker-entrypoint.sh: line 416:    28 Illegal instruction     &quot;$&#123;mongodHackedArgs[@]&#125;&quot; --fork</span><br><span class="line">mongo exited with code 132</span><br></pre></td></tr></table></figure>



<p>修复给docker-compose.yml配置<code>platform: linux/arm64</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mongo:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mongo:6.0</span></span><br><span class="line">    <span class="attr">platform:</span> <span class="string">linux/arm64</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mongo</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;27017:27017&quot;</span> </span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/orbDocker/mongo/configdb:/data/configdb</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">~/orbDocker/mongo/db:/data/db</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_USERNAME:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MONGO_INITDB_ROOT_PASSWORD:</span> <span class="string">root</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
                    
                        


                    
                    
                        <p>
                            <a
                                href="/2024/09/12/OrbStack-%E5%AE%89%E8%A3%85mongo5%E9%81%87%E5%88%B0%E7%9A%84%E9%94%99%E8%AF%AF%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2024/04/07/postgres-%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B/"
                            aria-label=": postgres 索引类型"
                        >
                            postgres 索引类型
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2024-04-07T16:26:46+00:00">
	
		    Apr 07, 2024
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h3 id="Postgres提供的索引类型"><a href="#Postgres提供的索引类型" class="headerlink" title="Postgres提供的索引类型"></a>Postgres提供的索引类型</h3><p>B+Tree, Hash, GIN, GiST, BRIN</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2024/04/07/postgres-%E7%B4%A2%E5%BC%95%E7%B1%BB%E5%9E%8B/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2024/03/04/Postgres%E6%8A%80%E5%B7%A7/"
                            aria-label=": Postgres技巧"
                        >
                            Postgres技巧
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2024-03-04T15:09:27+00:00">
	
		    Mar 04, 2024
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="Lock"><a href="#Lock" class="headerlink" title="Lock"></a>Lock</h2><h3 id="查找空闲且可能被锁定的进程。"><a href="#查找空闲且可能被锁定的进程。" class="headerlink" title="查找空闲且可能被锁定的进程。"></a>查找空闲且可能被锁定的进程。</h3><blockquote>
<p>这个查询查看pg_stat_activity视图，查找那些活跃但是等待事件或等待事件类型不为空的进程。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">		pid,</span><br><span class="line">		datname,</span><br><span class="line">		usename,</span><br><span class="line">		application_name,</span><br><span class="line">		client_addr,</span><br><span class="line">		client_port,</span><br><span class="line">		to_char (now (), <span class="string">&#x27;YYYY-MM-DD HH24:MI:SS&#x27;</span>) <span class="keyword">as</span> now,</span><br><span class="line">		to_char (now () <span class="operator">-</span> xact_start, <span class="string">&#x27;DD HH24:MI:SS MS&#x27;</span>) <span class="keyword">as</span> xact_time,</span><br><span class="line">		to_char (now () <span class="operator">-</span> query_start, <span class="string">&#x27;DD HH24:MI:SS MS&#x27;</span>) <span class="keyword">as</span> query_time,</span><br><span class="line">		state,</span><br><span class="line">		to_char (now () <span class="operator">-</span> state_change, <span class="string">&#x27;DD HH24:MI:SS MS&#x27;</span>) <span class="keyword">as</span> state_time,</span><br><span class="line">		wait_event,</span><br><span class="line">		wait_event_type,</span><br><span class="line">		<span class="keyword">left</span> (query, <span class="number">40</span>)</span><br><span class="line">	  <span class="keyword">FROM</span></span><br><span class="line">		pg_stat_activity</span><br><span class="line">	  <span class="keyword">WHERE</span></span><br><span class="line">		state <span class="operator">!=</span> <span class="string">&#x27;idle&#x27;</span></span><br><span class="line">		<span class="keyword">and</span> pid <span class="operator">!=</span> pg_backend_pid ()</span><br><span class="line">	  <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">		query_time <span class="keyword">desc</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="找到具有等待事件的进程，向持有初始锁的PID汇总"><a href="#找到具有等待事件的进程，向持有初始锁的PID汇总" class="headerlink" title="找到具有等待事件的进程，向持有初始锁的PID汇总"></a>找到具有等待事件的进程，向持有初始锁的PID汇总</h3><blockquote>
<p>This query looks at at the pg_stat_activity and pg_locks view showing the pid, state, wait_event, and lock mode, as well as blocking pids.<br>这个查询查看了 pg_stat_activity 和 pg_locks 视图，显示了 pid、state、wait_event 和 lock mode，以及阻塞的 pid。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">WITH</span> sos <span class="keyword">AS</span> (</span><br><span class="line">			<span class="keyword">SELECT</span> array_cat(<span class="built_in">array_agg</span>(pid),</span><br><span class="line">				   <span class="built_in">array_agg</span>((pg_blocking_pids(pid))[array_length(pg_blocking_pids(pid),<span class="number">1</span>)])) pids</span><br><span class="line">			<span class="keyword">FROM</span> pg_locks</span><br><span class="line">			<span class="keyword">WHERE</span> <span class="keyword">NOT</span> granted</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">SELECT</span> a.pid, a.usename, a.datname, a.state,</span><br><span class="line">			   a.wait_event_type <span class="operator">||</span> <span class="string">&#x27;: &#x27;</span> <span class="operator">||</span> a.wait_event <span class="keyword">AS</span> wait_event,</span><br><span class="line">			   <span class="built_in">current_timestamp</span><span class="operator">-</span>a.state_change time_in_state,</span><br><span class="line">			   <span class="built_in">current_timestamp</span><span class="operator">-</span>a.xact_start time_in_xact,</span><br><span class="line">			   l.relation::regclass relname,</span><br><span class="line">			   l.locktype, l.mode, l.page, l.tuple,</span><br><span class="line">			   pg_blocking_pids(l.pid) blocking_pids,</span><br><span class="line">			   (pg_blocking_pids(l.pid))[array_length(pg_blocking_pids(l.pid),<span class="number">1</span>)] last_session,</span><br><span class="line">			   <span class="built_in">coalesce</span>((pg_blocking_pids(l.pid))[<span class="number">1</span>]<span class="operator">||</span><span class="string">&#x27;.&#x27;</span><span class="operator">||</span><span class="built_in">coalesce</span>(<span class="keyword">case</span> <span class="keyword">when</span> locktype<span class="operator">=</span><span class="string">&#x27;transactionid&#x27;</span> <span class="keyword">then</span> <span class="number">1</span> <span class="keyword">else</span> array_length(pg_blocking_pids(l.pid),<span class="number">1</span>)<span class="operator">+</span><span class="number">1</span> <span class="keyword">end</span>,<span class="number">0</span>),a.pid<span class="operator">||</span><span class="string">&#x27;.0&#x27;</span>) lock_depth,</span><br><span class="line">			   a.query</span><br><span class="line">		<span class="keyword">FROM</span> pg_stat_activity a</span><br><span class="line">			 <span class="keyword">JOIN</span> sos s <span class="keyword">on</span> (a.pid <span class="operator">=</span> <span class="keyword">any</span>(s.pids))</span><br><span class="line">			 <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> pg_locks l <span class="keyword">on</span> (a.pid <span class="operator">=</span> l.pid <span class="keyword">and</span> <span class="keyword">not</span> l.granted)</span><br><span class="line">		<span class="keyword">ORDER</span> <span class="keyword">BY</span> lock_depth;</span><br></pre></td></tr></table></figure>

<h3 id="Set-a-lock-timeout"><a href="#Set-a-lock-timeout" class="headerlink" title="Set a lock timeout"></a>Set a lock timeout</h3><blockquote>
<p>It can be a good idea to set a lock_timeout within a session so that it will cancel the transaction and relinquish any locks it was holding after a certain period of time.<br>在会话中设置一个锁定超时可能是个好主意，这样在一段时间后它会取消事务并释放任何它持有的锁。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">SYSTEM</span> <span class="keyword">SET</span> lock_timeout <span class="operator">=</span> <span class="string">&#x27;10s&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h2><h3 id="设置log-min-duration-statement来记录慢查询。"><a href="#设置log-min-duration-statement来记录慢查询。" class="headerlink" title="设置log_min_duration_statement来记录慢查询。"></a>设置log_min_duration_statement来记录慢查询。</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> database postgres <span class="keyword">SET</span> log_min_duration_statement <span class="operator">=</span> <span class="string">&#x27;250ms&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="控制记录哪些类型的语句"><a href="#控制记录哪些类型的语句" class="headerlink" title="控制记录哪些类型的语句"></a>控制记录哪些类型的语句</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE postgres <span class="keyword">SET</span> log_statement <span class="operator">=</span> <span class="string">&#x27;all&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="等待锁时记录"><a href="#等待锁时记录" class="headerlink" title="等待锁时记录"></a>等待锁时记录</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE postgres <span class="keyword">SET</span> log_lock_waits <span class="operator">=</span> <span class="string">&#x27;on&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="PERFORMANCE"><a href="#PERFORMANCE" class="headerlink" title="PERFORMANCE"></a>PERFORMANCE</h2><h3 id="使用语句超时来控制运行超时的查询。"><a href="#使用语句超时来控制运行超时的查询。" class="headerlink" title="使用语句超时来控制运行超时的查询。"></a>使用语句超时来控制运行超时的查询。</h3><blockquote>
<p>Setting a statement timeout prevents queries from running longer than the specified time. You can set a statement timeout on the database, user, or session level. We recommend you set a global timeout on Postgres and then override that one specific users or sessions that need a longer allowed time to run.<br>设置语句超时时间可以防止查询运行时间超过指定的时间。您可以在数据库、用户或会话级别上设置语句超时时间。我们建议您在Postgres上设置一个全局超时时间，然后针对需要更长运行时间的特定用户或会话进行覆盖设置。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> DATABASE mydatabase <span class="keyword">SET</span> statement_timeout <span class="operator">=</span> <span class="string">&#x27;60s&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="使用pg-stat-statements-需要安装-来查找使用最多资源的查询和进程。"><a href="#使用pg-stat-statements-需要安装-来查找使用最多资源的查询和进程。" class="headerlink" title="使用pg_stat_statements[需要安装]来查找使用最多资源的查询和进程。"></a>使用pg_stat_statements[需要安装]来查找使用最多资源的查询和进程。</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 安装pg_stat_statements</span></span><br><span class="line"><span class="comment">-- Create the extension</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> EXTENSION pg_stat_statements;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Change in config</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> shared_preload_libraries<span class="operator">=</span><span class="string">&#x27;pg_stat_statements&#x27;</span>;</span><br><span class="line">Restart</span><br><span class="line"></span><br><span class="line"><span class="comment">-- systemctl restart postgresql</span></span><br><span class="line"><span class="comment">-- Verify changes applied or not.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> pg_file_Settings <span class="keyword">where</span> name<span class="operator">=</span><span class="string">&#x27;shared_preload_libraries&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">	total_exec_time,</span><br><span class="line">	mean_exec_time <span class="keyword">as</span> avg_ms,</span><br><span class="line">	calls,</span><br><span class="line">	query</span><br><span class="line"><span class="keyword">FROM</span> pg_stat_statements</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> mean_exec_time <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<h3 id="监视Postgres中的连接"><a href="#监视Postgres中的连接" class="headerlink" title="监视Postgres中的连接"></a>监视Postgres中的连接</h3><blockquote>
<p>This query will provide the number of connection based on type.<br>此查询将根据类型提供连接数量。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>),</span><br><span class="line">	   state</span><br><span class="line"><span class="keyword">FROM</span> pg_stat_activity</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> state;</span><br></pre></td></tr></table></figure>

<h3 id="查询特定表的大小"><a href="#查询特定表的大小" class="headerlink" title="查询特定表的大小"></a>查询特定表的大小</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> pg_relation_size(<span class="string">&#x27;table_name&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- For prettier formatting you can wrap with:</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> pg_size_pretty(pg_relation_size(<span class="string">&#x27;table_name&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h3 id="查询所有表的大小"><a href="#查询所有表的大小" class="headerlink" title="查询所有表的大小"></a>查询所有表的大小</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> relname <span class="keyword">AS</span> relation,</span><br><span class="line">       pg_size_pretty (</span><br><span class="line">         pg_total_relation_size (C .oid)</span><br><span class="line">       ) <span class="keyword">AS</span> total_size</span><br><span class="line"><span class="keyword">FROM</span> pg_class C</span><br><span class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> pg_namespace N <span class="keyword">ON</span> (N.oid <span class="operator">=</span> C .relnamespace)</span><br><span class="line"><span class="keyword">WHERE</span> nspname <span class="keyword">NOT</span> <span class="keyword">IN</span> (</span><br><span class="line">        <span class="string">&#x27;pg_catalog&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;information_schema&#x27;</span></span><br><span class="line">      )</span><br><span class="line">  <span class="keyword">AND</span> C .relkind <span class="operator">&lt;&gt;</span> <span class="string">&#x27;i&#x27;</span></span><br><span class="line">  <span class="keyword">AND</span> nspname <span class="operator">!</span><span class="operator">~</span> <span class="string">&#x27;^pg_toast&#x27;</span></span><br><span class="line">  <span class="keyword">ORDER</span> <span class="keyword">BY</span> pg_total_relation_size (C .oid) <span class="keyword">DESC</span></span><br></pre></td></tr></table></figure>

<h3 id="检查未使用的索引。"><a href="#检查未使用的索引。" class="headerlink" title="检查未使用的索引。"></a>检查未使用的索引。</h3><blockquote>
<p>Will return the unused indexes in descending order of size. Keep in mind you want to also check replicas before dropping indexes.</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> schemaname <span class="operator">||</span> <span class="string">&#x27;.&#x27;</span> <span class="operator">||</span> relname <span class="keyword">AS</span> <span class="keyword">table</span>,</span><br><span class="line">       indexrelname <span class="keyword">AS</span> index,</span><br><span class="line">       pg_size_pretty(pg_relation_size(i.indexrelid)) <span class="keyword">AS</span> &quot;index size&quot;,</span><br><span class="line">       idx_scan <span class="keyword">as</span> &quot;index scans&quot;</span><br><span class="line"><span class="keyword">FROM</span> pg_stat_user_indexes ui</span><br><span class="line"><span class="keyword">JOIN</span> pg_index i <span class="keyword">ON</span> ui.indexrelid <span class="operator">=</span> i.indexrelid</span><br><span class="line"><span class="keyword">WHERE</span> <span class="keyword">NOT</span> indisunique</span><br><span class="line">  <span class="keyword">AND</span> idx_scan <span class="operator">&lt;</span> <span class="number">50</span></span><br><span class="line">  <span class="keyword">AND</span> pg_relation_size(relid) <span class="operator">&gt;</span> <span class="number">5</span> <span class="operator">*</span> <span class="number">8192</span></span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> </span><br><span class="line">  pg_relation_size(i.indexrelid) <span class="operator">/</span> <span class="built_in">nullif</span>(idx_scan, <span class="number">0</span>) <span class="keyword">DESC</span> <span class="keyword">NULLS FIRST</span>,</span><br><span class="line">  pg_relation_size(i.indexrelid) <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>

<h3 id="获取表格的近似计数"><a href="#获取表格的近似计数" class="headerlink" title="获取表格的近似计数"></a>获取表格的近似计数</h3><blockquote>
<p>Will return the approximate count for a table based on PostgreSQL internal statistics. Useful for large tables where performing a <code>SELECT count(*)</code> is costly on performance.</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> reltuples::<span class="type">numeric</span> <span class="keyword">as</span> count</span><br><span class="line"><span class="keyword">FROM</span> pg_class</span><br><span class="line"><span class="keyword">WHERE</span> relname<span class="operator">=</span><span class="string">&#x27;table_name&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Non-blocking-创建索引"><a href="#Non-blocking-创建索引" class="headerlink" title="Non-blocking 创建索引"></a>Non-blocking 创建索引</h3><blockquote>
<p>Adding <code>CONCURRENTLY</code> during index creation, while not permitted in a transaction, will not hold a lock on the table while creating your index.</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> INDEX CONCURRENTLY foobar <span class="keyword">ON</span> foo (bar);</span><br></pre></td></tr></table></figure>

<h2 id="PSQL"><a href="#PSQL" class="headerlink" title="PSQL"></a>PSQL</h2><h3 id="在PSQL中自动记录查询时间"><a href="#在PSQL中自动记录查询时间" class="headerlink" title="在PSQL中自动记录查询时间"></a>在PSQL中自动记录查询时间</h3><blockquote>
<p>将自动打印出在psql中运行查询所花费的时间。<em>需要注意的是这是往返时间，而不仅仅是查询执行时间。</em></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\timing</span><br></pre></td></tr></table></figure>

<h3 id="在-psql-中自动格式化查询结果"><a href="#在-psql-中自动格式化查询结果" class="headerlink" title="在 psql 中自动格式化查询结果"></a>在 psql 中自动格式化查询结果</h3><blockquote>
<p>将根据您的终端窗口自动重新组织查询输出，以便更易读。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x auto</span><br></pre></td></tr></table></figure>

<h3 id="编辑您选择的编辑器中的psql查询"><a href="#编辑您选择的编辑器中的psql查询" class="headerlink" title="编辑您选择的编辑器中的psql查询"></a>编辑您选择的编辑器中的psql查询</h3><blockquote>
<p>将自动在您的默认 <code>$EDITOR</code> 中打开您上次运行的查询。当您保存并关闭时，将执行该查询。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\e</span><br></pre></td></tr></table></figure>

<h3 id="为nulls设置一个值"><a href="#为nulls设置一个值" class="headerlink" title="为nulls设置一个值"></a>为nulls设置一个值</h3><blockquote>
<p>将null渲染为您指定的任何字符。对于更容易解析null和空文本非常方便。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\pset <span class="keyword">null</span> 👻</span><br></pre></td></tr></table></figure>

<h3 id="将您的每个数据库的查询历史保存在本地"><a href="#将您的每个数据库的查询历史保存在本地" class="headerlink" title="将您的每个数据库的查询历史保存在本地"></a>将您的每个数据库的查询历史保存在本地</h3><blockquote>
<p>将为每个<strong>DBNAME</strong>自动保存一个历史文件。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="keyword">set</span> HISTFILE <span class="operator">~</span><span class="operator">/</span>.psql_history<span class="operator">-</span> :DBNAME</span><br></pre></td></tr></table></figure>

<h3 id="显示由内部psql命令发出的查询"><a href="#显示由内部psql命令发出的查询" class="headerlink" title="显示由内部psql命令发出的查询"></a>显示由内部psql命令发出的查询</h3><blockquote>
<p>在命令行中为 psql 添加“-E”（或–echo-hidden）选项。此选项将显示内部 psql 命令生成的查询（例如“\dt mytable”）。这是了解系统目录的更酷的方法，或者可以重用由 psql 发出的查询在您自己的工具中。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql <span class="operator">-</span>E</span><br></pre></td></tr></table></figure>

<h3 id="获取数据，只需数据。"><a href="#获取数据，只需数据。" class="headerlink" title="获取数据，只需数据。"></a>获取数据，只需数据。</h3><blockquote>
<p>在命令行中向psql添加”-qtA”选项。这些选项将使psql以安静模式(“-q”)运行，仅返回元组(“-t”)以不对齐的方式(“-A”)。结合”-c”选项发送单个查询，如果您只想从Postgres获取数据，这对于您的脚本可能很有用。每行返回一行。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql <span class="operator">-</span>qtA</span><br></pre></td></tr></table></figure>

<h3 id="以HTML表格的形式获取结果"><a href="#以HTML表格的形式获取结果" class="headerlink" title="以HTML表格的形式获取结果"></a>以HTML表格的形式获取结果</h3><blockquote>
<p>在命令行中为psql添加”-qtH”选项。这些选项将使psql以安静模式运行（”-q”），仅返回元组（”-t”）以HTML表格形式（”-H”）。结合”-c”选项发送单个查询，可以快速将查询结果嵌入到HTML页面中。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql <span class="operator">-</span>qtH</span><br></pre></td></tr></table></figure>

<h3 id="搜索以前的查询使用-Ctrl-R"><a href="#搜索以前的查询使用-Ctrl-R" class="headerlink" title="搜索以前的查询使用 Ctrl + R"></a>搜索以前的查询使用 Ctrl + R</h3><blockquote>
<p>按下Ctrl + R将启动搜索会话，然后您可以开始键入查询或命令的一部分，以找到并再次运行它。如果您使用注释标记特定查询，这可以帮助稍后进行搜索。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(reverse<span class="operator">-</span>i<span class="operator">-</span><span class="keyword">search</span>)</span><br></pre></td></tr></table></figure>

<h3 id="清除plsql屏幕"><a href="#清除plsql屏幕" class="headerlink" title="清除plsql屏幕"></a>清除plsql屏幕</h3><blockquote>
<p>将清除当前 psql 会话中的屏幕</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="operator">!</span> clear</span><br></pre></td></tr></table></figure>

<h3 id="持续使用watch命令运行查询"><a href="#持续使用watch命令运行查询" class="headerlink" title="持续使用watch命令运行查询"></a>持续使用watch命令运行查询</h3><blockquote>
<p>每2秒将自动运行上次的查询并显示输出。您也可以在watch后指定要运行的查询。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\watch</span><br></pre></td></tr></table></figure>

<h3 id="在交互模式下，当出现错误时回滚到上一个语句。"><a href="#在交互模式下，当出现错误时回滚到上一个语句。" class="headerlink" title="在交互模式下，当出现错误时回滚到上一个语句。"></a>在交互模式下，当出现错误时回滚到上一个语句。</h3><blockquote>
<p>当您在交互模式遇到错误时，系统会自动回滚到前一条命令之前的状态，使您可以像预期的那样继续工作。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\<span class="keyword">set</span> ON_ERROR_ROLLBACK interactive</span><br></pre></td></tr></table></figure>

<h3 id="直接从psql导出CSV"><a href="#直接从psql导出CSV" class="headerlink" title="直接从psql导出CSV"></a>直接从psql导出CSV</h3><blockquote>
<p>当使用查询时提供<code>--csv</code>值，该命令将运行特定查询并将CSV返回到标准输出。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql <span class="operator">&lt;</span>connection<span class="operator">-</span>string<span class="operator">&gt;</span> <span class="comment">--csv -c &#x27;select * from test;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="在psql中运行来自文件的查询"><a href="#在psql中运行来自文件的查询" class="headerlink" title="在psql中运行来自文件的查询"></a>在psql中运行来自文件的查询</h3><blockquote>
<p>在 psql 中执行指定的文件。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\i filename</span><br></pre></td></tr></table></figure>

<h3 id="在-psql-中提供清晰的边框"><a href="#在-psql-中提供清晰的边框" class="headerlink" title="在 psql 中提供清晰的边框"></a>在 psql 中提供清晰的边框</h3><blockquote>
<p>在psql中，当你查询结果输出时，会给结果加上边框。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\pset border <span class="number">2</span></span><br></pre></td></tr></table></figure>

<h2 id="Refer"><a href="#Refer" class="headerlink" title="Refer"></a>Refer</h2><p><a target="_blank" rel="noopener" href="https://www.crunchydata.com/postgres-tips">https://www.crunchydata.com/postgres-tips</a></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2024/03/04/Postgres%E6%8A%80%E5%B7%A7/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2024/01/25/%E7%90%86%E8%A7%A3https/"
                            aria-label=": 理解https"
                        >
                            理解https
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2024-01-25T17:05:17+00:00">
	
		    Jan 25, 2024
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    
                    
                        


                    
                    
                        <p>
                            <a
                                href="/2024/01/25/%E7%90%86%E8%A7%A3https/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2023/07/02/Java%E5%A4%9A%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7SDKMAN/"
                            aria-label=": Java多版本管理工具SDKMAN"
                        >
                            Java多版本管理工具SDKMAN
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2023-07-02T00:05:06+00:00">
	
		    Jul 02, 2023
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p>作为一名Javaer领到电脑的第一件事就是需要配置Java环境，以及切换不同的JDK版本来进行日常开发，Node开发有nvm，python开发有pyenv, Java也提供了响应的工具sdkman（Linux, Unix, MacOS）。同时sdkman也可以管理Scala、Gradle、Maven等等软件不同的版本。</p>
</blockquote>
<h2 id="安装-SDKMan-要开始使用-SDKMan，"><a href="#安装-SDKMan-要开始使用-SDKMan，" class="headerlink" title="安装 SDKMan 要开始使用 SDKMan，"></a>安装 SDKMan 要开始使用 SDKMan，</h2><p>首先需要在你的系统上安装它。SDKMan 支持 Windows、macOS 和 Linux 等操作系统。 </p>
<h3 id="在-macOS-和-Linux-上安装"><a href="#在-macOS-和-Linux-上安装" class="headerlink" title="在 macOS 和 Linux 上安装"></a>在 macOS 和 Linux 上安装</h3><p>在终端中执行以下命令来安装 SDKMan： </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;https://get.sdkman.io&quot;</span> | bash </span><br><span class="line"><span class="comment"># 或者 </span></span><br><span class="line">curl -s <span class="string">&quot;https://get.sdkman.io&quot;</span> | ZSH</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> <span class="string">&quot;<span class="variable">$HOME</span>/.sdkman/bin/sdkman-init.sh&quot;</span></span><br><span class="line">$ sdk version</span><br><span class="line"><span class="comment"># 如下，如果显示版本则代表成功</span></span><br><span class="line">  sdkman 5.18.2</span><br></pre></td></tr></table></figure>

<h3 id="在-Windows-上安装"><a href="#在-Windows-上安装" class="headerlink" title="在 Windows 上安装"></a>在 Windows 上安装</h3><p>在 Windows 上，你可以使用 Git Bash 或 Cygwin 等工具来安装和使用 SDKMan。首先，下载并安装 Git Bash 或 Cygwin，并确保它们在系统的 PATH 环境变量中。然后，在 Git Bash 或 Cygwin 终端中执行以下命令来安装 SDKMan：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s <span class="string">&quot;https://get.sdkman.io&quot;</span> | bash</span><br></pre></td></tr></table></figure>

<h2 id="使用-SDKMan"><a href="#使用-SDKMan" class="headerlink" title="使用 SDKMan"></a>使用 SDKMan</h2><p>一旦你安装好了 SDKMan，就可以开始使用它来管理你的开发工具了。</p>
<h3 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h3><p>使用 SDKMan 安装一个开发工具非常简单。比如，要安装最新版本的 Java，只需要在终端中执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sdk lis java <span class="comment">#显示出java所有版本</span></span><br><span class="line">sdk install java 17.0.3-oracle</span><br></pre></td></tr></table></figure>

<h3 id="切换版本"><a href="#切换版本" class="headerlink" title="切换版本"></a>切换版本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sdk use java 17.0.3-oracle</span><br></pre></td></tr></table></figure>

<h3 id="升级工具"><a href="#升级工具" class="headerlink" title="升级工具"></a>升级工具</h3><p>SDKMan 也提供了升级已安装工具的功能。要升级某个已安装的工具，只需要执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sdk upgrade &lt;tool&gt;</span><br></pre></td></tr></table></figure>

<p>其中 <code>&lt;tool&gt;</code> 是你想要升级的工具名称，比如 <code>java</code>、<code>scala</code>等。</p>
<h3 id="列出可用版本"><a href="#列出可用版本" class="headerlink" title="列出可用版本"></a>列出可用版本</h3><p>如果你想查看某个工具的所有可用版本，可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sdk list &lt;tool&gt;</span><br></pre></td></tr></table></figure>

<p>这将列出该工具所有可用的版本号供你选择。</p>
<h3 id="删除工具"><a href="#删除工具" class="headerlink" title="删除工具"></a>删除工具</h3><p>如果你想删除某个已安装的工具，可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sdk uninstall &lt;tool&gt; &lt;version&gt;</span><br></pre></td></tr></table></figure>

<p>其中 <code>&lt;tool&gt;</code> 是工具的名称，<code>&lt;version&gt;</code> 是要删除的版本号。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>SDKMan 是一个非常实用的开发工具管理工具，可以帮助开发人员轻松安装、升级和切换不同版本的开发工具。它简化了我们在不同项目中使用不同工具版本的过程，让开发变得更加便捷和高效。</p>
<p>如果你还没有尝试过 SDKMan，我强烈推荐你去官方网站（<a target="_blank" rel="noopener" href="https://sdkman.io/%EF%BC%89%E4%BA%86%E8%A7%A3%E6%9B%B4%E5%A4%9A%E4%BF%A1%E6%81%AF%EF%BC%8C%E5%B9%B6%E5%9C%A8%E4%BD%A0%E7%9A%84%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E4%B8%AD%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8%E5%AE%83%E3%80%82%E7%9B%B8%E4%BF%A1%E5%AE%83%E4%BC%9A%E6%88%90%E4%B8%BA%E4%BD%A0%E7%9A%84%E5%A5%BD%E5%B8%AE%E6%89%8B%EF%BC%81">https://sdkman.io/）了解更多信息，并在你的开发环境中安装和使用它。相信它会成为你的好帮手！</a></p>
<p>ChatGpt真强大这篇文章是它写的。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2023/07/02/Java%E5%A4%9A%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7SDKMAN/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2023/06/27/%E7%95%AA%E8%8C%84%E6%9E%B6%E6%9E%84-Tomato-Architecture/"
                            aria-label=": 番茄架构-Tomato Architecture"
                        >
                            番茄架构-Tomato Architecture
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2023-06-27T23:07:42+00:00">
	
		    Jun 27, 2023
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Architecture/">Architecture</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p><strong>番茄架构</strong>是遵循<strong>Common Sense Manifesto</strong>的软件架构的一种方法</p>
</blockquote>
<h3 id="Common-Sense-Manifesto"><a href="#Common-Sense-Manifesto" class="headerlink" title="Common Sense Manifesto"></a>Common Sense Manifesto</h3><ul>
<li>选择适合你的软件的架构而不是流行的的架构： 在盲目追随流行人物的建议之前，要考虑软件最佳实践。</li>
<li>不要过度设计： 努力保持简单，而不是过度工程化，试图猜测未来十年的需求。</li>
<li>进行研究与开发，选择一项技术并拥抱它，而不是为了可替代性而创建抽象层。</li>
<li>确保你的解决方案作为整体工作正常，而不仅仅是单个组件。</li>
</ul>
<h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><p><img src="https://cdn.jsdelivr.net/gh/wenPKtalk/pictures@master/blog/20230628/17_58/tomato-architecture.png" alt="tomato-architecture.png"></p>
<h3 id="实施指南（架构核心：关注点分离）："><a href="#实施指南（架构核心：关注点分离）：" class="headerlink" title="实施指南（架构核心：关注点分离）："></a>实施指南（架构核心：关注点分离）：</h3><ol>
<li><h3 id="按功能进行打包"><a href="#按功能进行打包" class="headerlink" title="按功能进行打包"></a>按功能进行打包</h3>将代码按照功能分成不同的包是一种常见的模式，通常会根据技术层次（如 controllers, services, repositories等）进行划分。如果你正在构建一个专注于特定模块或业务能力的微服务，那么这种方法可能是可行的。</li>
</ol>
<p>  如果你正在构建一个单体应用或者模块化单体应用，强烈建议首先按照功能而非技术层进行划分。</p>
<p>  详细信息请阅读链接: <a target="_blank" rel="noopener" href="https://phauer.com/2020/package-by-feature/">https://phauer.com/2020/package-by-feature/</a></p>
<ol start="2">
<li><h3 id="“应用核心”独立于交付机制（Web-Scheduler-Jobs-CLI）"><a href="#“应用核心”独立于交付机制（Web-Scheduler-Jobs-CLI）" class="headerlink" title="“应用核心”独立于交付机制（Web, Scheduler Jobs, CLI）"></a>“应用核心”独立于交付机制（Web, Scheduler Jobs, CLI）</h3><p>应用核心应该公开可以从主方法调用的API。为了实现这一点，“应用核心”不应该依赖于其调用上下文。这意味着“应用核心”不应依赖于任何HTTP/Web层的库。同样，如果你的应用核心被用于定时任务或命令行接口，任何调度逻辑或命令行执行逻辑都不应泄露到应用核心中。</p>
</li>
<li><h3 id="将业务逻辑执行与输入源（Web-Controllers-Message-Listeners-Scheduled-Jobs等）分离"><a href="#将业务逻辑执行与输入源（Web-Controllers-Message-Listeners-Scheduled-Jobs等）分离" class="headerlink" title="将业务逻辑执行与输入源（Web Controllers, Message Listeners, Scheduled Jobs等）分离"></a>将业务逻辑执行与输入源（Web Controllers, Message Listeners, Scheduled Jobs等）分离</h3><p>输入源，如Web Controllers, Message Listeners, Scheduled Jobs等，应该是很薄的一层，在提取请求数据后将实际的业务逻辑执行委托给“应用核心”。</p>
</li>
</ol>
<p>比如：</p>
<p><strong>坏味道：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomerController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CustomerService customerService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/api/customers&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createCustomer</span><span class="params">(<span class="meta">@RequestBody</span> Customer customer)</span> &#123;</span><br><span class="line">       <span class="keyword">if</span>(customerService.existsByEmail(customer.getEmail())) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EmailAlreadyInUseException</span>(customer.getEmail());</span><br><span class="line">       &#125;</span><br><span class="line">       customer.setCreateAt(Instant.now());</span><br><span class="line">       customerService.save(customer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>纠正：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomerController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CustomerService customerService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(&quot;/api/customers&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createCustomer</span><span class="params">(<span class="meta">@RequestBody</span> Customer customer)</span> &#123;</span><br><span class="line">       customerService.save(customer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomerService</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> CustomerRepository customerRepository;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">save</span><span class="params">(Customer customer)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span>(customerRepository.existsByEmail(customer.getEmail())) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">EmailAlreadyInUseException</span>(customer.getEmail());</span><br><span class="line">      &#125;</span><br><span class="line">      customer.setCreateAt(Instant.now());</span><br><span class="line">      customerRepository.save(customer);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>采用这种方法，无论你是通过REST API调用还是通过CLI创建一个客户，所有的业务逻辑都会集中在应用核心中。</p>
<p><strong>坏味道：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderProcessingJob</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderService orderService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Scheduled(cron=&quot;0 * * * * *&quot;)</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">       List&lt;Order&gt; orders = orderService.findPendingOrders();</span><br><span class="line">       <span class="keyword">for</span>(Order order : orders) &#123;</span><br><span class="line">           <span class="built_in">this</span>.processOrder(order);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processOrder</span><span class="params">(Order order)</span> &#123;</span><br><span class="line">       ...</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>纠正：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderProcessingJob</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Scheduled(cron=&quot;0 * * * * *&quot;)</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      List&lt;Order&gt; orders = orderService.findPendingOrders();</span><br><span class="line">      orderService.processOrders(orders);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processOrders</span><span class="params">(List&lt;Order&gt; orders)</span> &#123;</span><br><span class="line">       ...</span><br><span class="line">       ...</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>采用这种方法，你可以将订单处理逻辑与调度程序解耦，可以在没有通过调度程序触发的情况下独立进行测试。</p>
<ol start="4">
<li><h3 id="不要让“外部服务集成”对“应用核心”产生太大影响"><a href="#不要让“外部服务集成”对“应用核心”产生太大影响" class="headerlink" title="不要让“外部服务集成”对“应用核心”产生太大影响"></a>不要让“外部服务集成”对“应用核心”产生太大影响</h3><p>从应用核心，我们可能需要与数据库、消息代理或第三方Web服务等进行通信。必须注意的是，业务逻辑执行器不应过度依赖于外部服务集成。</p>
<p>例如，假设你正在使用Spring Data JPA进行持久化，而你想从CustomerService中使用分页获取客户。</p>
<p><strong>坏味道：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomerService</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> CustomerRepository customerRepository;</span><br><span class="line"></span><br><span class="line">   PagedResult&lt;Customer&gt; <span class="title function_">getCustomers</span><span class="params">(Integer pageNo)</span> &#123;</span><br><span class="line">      <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> PageRequest.of(pageNo, PAGE_SIZE, Sort.of(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">      Page&lt;Customer&gt; cusomersPage = customerRepository.findAll(pageable);</span><br><span class="line">      <span class="keyword">return</span> convertToPagedResult(cusomersPage);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>纠正：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomerService</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> CustomerRepository customerRepository;</span><br><span class="line"></span><br><span class="line">   PagedResult&lt;Customer&gt; <span class="title function_">getCustomers</span><span class="params">(Integer pageNo)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> customerRepository.findAll(pageNo);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JpaCustomerRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">   PagedResult&lt;Customer&gt; <span class="title function_">findAll</span><span class="params">(Integer pageNo)</span> &#123;</span><br><span class="line">      <span class="type">Pageable</span> <span class="variable">pageable</span> <span class="operator">=</span> PageRequest.of(pageNo, PAGE_SIZE, Sort.of(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">      <span class="keyword">return</span> ...;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种方式下，任何持久化库的修改都只会影响到持久化层。</p>
</li>
<li><h3 id="将领域（domain）逻辑处理放在领域对象中"><a href="#将领域（domain）逻辑处理放在领域对象中" class="headerlink" title="将领域（domain）逻辑处理放在领域对象中"></a>将领域（domain）逻辑处理放在领域对象中</h3><p>如果一个方法仅仅影响领域对象中的状态或者是根据领域对象状态计算某些内容的方法，则该方法应该是属于领域对象。</p>
<p><strong>坏味道：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Cart</span> &#123;</span><br><span class="line">    List&lt;LineItem&gt; items;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CartService</span> &#123;</span><br><span class="line"></span><br><span class="line">   CartDTO <span class="title function_">getCart</span><span class="params">(UUID cartId)</span> &#123;</span><br><span class="line">      <span class="type">Cart</span> <span class="variable">cart</span> <span class="operator">=</span> cartRepository.getCart(cartId);</span><br><span class="line">      <span class="type">BigDecimal</span> <span class="variable">cartTotal</span> <span class="operator">=</span> <span class="built_in">this</span>.calculateCartTotal(cart);</span><br><span class="line">      ...</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> BigDecimal <span class="title function_">calculateCartTotal</span><span class="params">(Cart cart)</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>纠正：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Cart</span> &#123;</span><br><span class="line">    List&lt;LineItem&gt; items;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> BigDecimal <span class="title function_">getTotal</span><span class="params">()</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CartService</span> &#123;</span><br><span class="line"></span><br><span class="line">   CartDTO <span class="title function_">getCart</span><span class="params">(UUID cartId)</span> &#123;</span><br><span class="line">      <span class="type">Cart</span> <span class="variable">cart</span> <span class="operator">=</span> cartRepository.getCart(cartId);</span><br><span class="line">      <span class="type">BigDecimal</span> <span class="variable">cartTotal</span> <span class="operator">=</span> cart.getTotal();</span><br><span class="line">      ...</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><h3 id="不要创建没有必要的接口"><a href="#不要创建没有必要的接口" class="headerlink" title="不要创建没有必要的接口"></a>不要创建没有必要的接口</h3><p>不要创建接口并希望有一天我们可以为此接口添加另一个实现。如果那一天真的到来，那么利用我们现在拥有的强大的 IDE，只需敲击几下键盘即可提取界面。如果创建接口的原因是为了使用 Mock 实现进行测试，我们有像 Mockito 这样的模拟库，它能够在不实现接口的情况下模拟类。</p>
<p>因此，除非有充分的理由，否则不要创建接口。</p>
</li>
<li><h3 id="拥抱框架强大的功能和灵活性"><a href="#拥抱框架强大的功能和灵活性" class="headerlink" title="拥抱框架强大的功能和灵活性"></a>拥抱框架强大的功能和灵活性</h3><p>通常，创建库和框架是为了满足大多数应用程序所需的常见要求。因此，您应该选择一个库/框架来更快地构建应用程序时。</p>
<p>与其利用所选框架提供的功能和灵活性，不如在所选框架之上创建间接或抽象，并希望有一天您可以将框架切换到其他框架，这通常是一个非常糟糕的主意。</p>
<p>例如，Spring框架为处理数据库事务、缓存、方法级安全性等提供了声明性支持。引入我们自己的类似注释并通过将实际处理委托给框架来重新实现相同的功能支持是不必要的。</p>
<p>相反，最好直接使用框架的注释，或者根据需要使用附加语义来组合注释。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> UseCase &#123;</span><br><span class="line">   <span class="meta">@AliasFor(</span></span><br><span class="line"><span class="meta">        annotation = Transactional.class</span></span><br><span class="line"><span class="meta">   )</span></span><br><span class="line">   Propagation <span class="title function_">propagation</span><span class="params">()</span> <span class="keyword">default</span> Propagation.REQUIRED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><h3 id="不仅单元测试，也需要集成测试。"><a href="#不仅单元测试，也需要集成测试。" class="headerlink" title="不仅单元测试，也需要集成测试。"></a>不仅单元测试，也需要集成测试。</h3><p>我们绝对应该编写单元测试来测试单元（业务逻辑），如果需要，可以通过模拟外部依赖项。但更重要的是验证整个功能是否正常工作。</p>
<p>即使我们的单元测试以毫秒为单位运行，我们是否可以放心地投入生产？当然不是。我们应该通过测试实际的外部依赖项（例如数据库或消息代理）来验证整个功能是否正常工作。这让我们更有信心。</p>
<p>我想知道“我们应该拥有完全独立于外部依赖项的核心域”哲学的整个想法来自于使用真实依赖项进行测试非常具有挑战性或根本不可能的时代。</p>
<p>幸运的是，我们现在拥有更好的技术（例如：<a target="_blank" rel="noopener" href="https://testcontainers.com/">testcontainer</a> 运行测试时动态启动依赖的中间件容器技术）来测试真正的依赖关系。使用真正的依赖项进行测试可能会花费稍多的时间，但与好处相比，这是一个可以忽略不计的成本。</p>
</li>
</ol>
<p>学习于原文：<a target="_blank" rel="noopener" href="https://github.com/wenPKtalk/tomato-architecture">https://github.com/wenPKtalk/tomato-architecture</a></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2023/06/27/%E7%95%AA%E8%8C%84%E6%9E%B6%E6%9E%84-Tomato-Architecture/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2023/02/17/docker%E9%87%8C%E7%9A%84mongo%20WiredTiger%20error%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"
                            aria-label=": docker里的mongo WiredTiger error 解决方法"
                        >
                            docker里的mongo WiredTiger error 解决方法
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2023-02-17T18:30:42+00:00">
	
		    Feb 17, 2023
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/DevOps/">DevOps</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><blockquote>
<p>电脑强制重启后，docker里的mongo不能正常使用，索引不能位置被破坏，错误log是这样的： error: WT_ERROR: non-specific WiredTiger error”}</p>
</blockquote>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><ol>
<li>简历另外一个容器，volume挂载和上一个容器一样的位置：</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name=<span class="string">&quot;mongofix&quot;</span> \</span><br><span class="line">    -p 27017:27017 \</span><br><span class="line">    -p 27018:27018 \</span><br><span class="line">    -p 27019:27019 \</span><br><span class="line">    -e TIMEZONE=<span class="string">&quot;Australia/Brisbane&quot;</span> \</span><br><span class="line">    -e TZ=<span class="string">&quot;Australia/Brisbane&quot;</span> \</span><br><span class="line">    -v &#123;本地挂载目录&#125;/configdb:/data/configdb \</span><br><span class="line">    -v &#123;本地挂载目录&#125;/db:/data/db \</span><br><span class="line">    mongo:latest /bin/bash</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>删除几个lock文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -r journal</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -r mongod.lock</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -r WiredTiger.lock</span></span><br></pre></td></tr></table></figure></li>
<li><p>进入mongofix容器</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mongo /bin/sh</span><br><span class="line"><span class="comment"># mongod --repair</span></span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这也提供了一条思路，如果因为挂载文件损坏，容器不能正常启动，所以不能进入容器运行修复命令，可以先创建其它容器，进入容器后进行修复。然后restart老的容器。</p>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p><a target="_blank" rel="noopener" href="https://gist.github.com/mtrunkat/203c33347cc96db51a754a45bb902669?permalink_comment_id=2693735">https://gist.github.com/mtrunkat/203c33347cc96db51a754a45bb902669?permalink_comment_id=2693735</a></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2023/02/17/docker%E9%87%8C%E7%9A%84mongo%20WiredTiger%20error%20%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2023/02/09/%E5%9B%A2%E9%98%9F%E5%A6%82%E4%BD%95%E7%94%A8%E5%A5%BDgit/"
                            aria-label=": 团队如何用好git"
                        >
                            团队如何用好git
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2023-02-09T09:25:38+00:00">
	
		    Feb 09, 2023
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Git/">Git</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <ol>
<li><p>常用团队规范，包含Git 使用原则、分支设计、单线分支原则、开发规范<br><a target="_blank" rel="noopener" href="https://blog.meathill.com/git/git-1-team-sop.html">https://blog.meathill.com/git/git-1-team-sop.html</a></p>
</li>
<li><p>常见问题解决，包含处理 hotfix、git rebase dev -i、git reset –hard COMMIT<br><a target="_blank" rel="noopener" href="https://blog.meathill.com/git/2023-git-2-faq.html">https://blog.meathill.com/git/2023-git-2-faq.html</a></p>
</li>
<li><p>Git推荐配置与小技巧，包含<br><a target="_blank" rel="noopener" href="https://blog.meathill.com/git/2023-git-3-tips.html">https://blog.meathill.com/git/2023-git-3-tips.html</a></p>
</li>
<li><p>Mac用户使用Item2+zsh中的主题自带了Git的常见alias，可以使用 alias |grep git进行查看：</p>
<p>常用的有：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gup = git  pull --rebase</span><br><span class="line">gp = git push</span><br><span class="line">gl = git pull</span><br><span class="line">gcam = git commit -a -m</span><br><span class="line">gca! = git commit -v -a --amend</span><br></pre></td></tr></table></figure></li>
</ol>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2023/02/09/%E5%9B%A2%E9%98%9F%E5%A6%82%E4%BD%95%E7%94%A8%E5%A5%BDgit/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/2022/09/14/%E4%B8%80%E4%B8%AAJava%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AEmac%E7%AF%87/"
                            aria-label=": 一个程序员的职业素养"
                        >
                            一个程序员的职业素养
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2022-09-14T22:09:51+00:00">
	
		    Sep 14, 2022
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Resource/">Resource</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p>一个团队中的开发环境和开发习惯的统一是可以避免很多问题的。这儿是把之前郑大的在我们团队中提出的要求做一个备份。</p>
</blockquote>
<p>基础开发环境</p>
<p>Mac 操作系统设置</p>
<ul>
<li>把 F1、F2 当做标准的功能键（System Preferences -&gt; Keyboard -&gt; 勾选 Use F1, F2, etc. key as standard key function keys.）</li>
</ul>
<p>安装输入法</p>
<ul>
<li>推荐使用搜狗输入法，<a target="_blank" rel="noopener" href="https://pinyin.sogou.com/mac/">点我安装</a>。</li>
</ul>
<p>安装 Iterm2</p>
<ul>
<li>推荐使用 Iterm2 作为命令行终端，<a target="_blank" rel="noopener" href="https://www.iterm2.com/">点我安装</a>。</li>
<li>Iterm2 的文档如下：</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.iterm2.com/documentation.html">https://www.iterm2.com/documentation.html</a></p>
<p>安装Homebrew</p>
<ul>
<li>brew是MAC OS开源的包管理器，<a target="_blank" rel="noopener" href="https://brew.sh/index_zh-cn">点我安装</a>。</li>
</ul>
<p>温馨提示:</p>
<ol>
<li>连接被拒绝问题解决请参考：<a target="_blank" rel="noopener" href="https://github.com/hawtim/blog/issues/10">GitHub DNS解析被污染，手动进行域名映射</a></li>
<li>官方源下载速度慢问题解决请参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/claram/article/details/101577547">将官方源切换成国内源</a></li>
</ol>
<p>安装 zsh &amp; oh-my-zsh</p>
<ul>
<li><p>推荐使用 ZSH 作为缺省的 Shell，请确认 ZSH 是否安装。</p>
</li>
<li><p>使用如下命令检查当前 Shell：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo $SHELL</span><br></pre></td></tr></table></figure>

<p>  使用如下命令检查是否 ZSH： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">which zsh</span><br></pre></td></tr></table></figure>

<ul>
<li>若未安装，使用如下命令进行安装：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install zsh</span><br></pre></td></tr></table></figure>

<p>  使用如下命令进行 Shell 切换：</p>
<p><code>chsh -s </code>which zsh``</p>
<p>  切换后，重启终端即可。</p>
<ul>
<li>使用 oh-my-zsh 配置 ZSH，使用如下命令进行安装：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c &quot;$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>oh-my-zsh 的文档如下：</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/ohmyzsh/ohmyzsh/wiki">https://github.com/ohmyzsh/ohmyzsh/wiki</a></p>
<ul>
<li>在 ~/.zshrc 中进行配置</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export ZSH=/Users/dreamhead/.oh-my-zsh # oh-my-zsh 的安装路径</span><br><span class="line">ZSH_THEME=&quot;robbyrussell&quot; # 启用主题，请选用有 Git 分支提示的主题</span><br><span class="line">plugins=(git) # 启用插件，请启用 Git 插件</span><br><span class="line">source $ZSH/oh-my-zsh.sh # 启用 oh-my-zsh</span><br></pre></td></tr></table></figure>

<ul>
<li>推荐插件：Git</li>
</ul>
<p>安装 Git &amp; Git Flow</p>
<p>推荐使用 Git 作为版本控制工具，使用 Git Flow 作为基本的研发过程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install git</span><br><span class="line">brew install git-flow</span><br></pre></td></tr></table></figure>

<p>安装 IntelliJ IDEA</p>
<p>对于 Java 程序员，推荐使用 IntelliJ IDEA Community Edition 作为开发环境，<a target="_blank" rel="noopener" href="https://www.jetbrains.com/idea/download/">点我安装</a>。</p>
<ul>
<li>推荐Keymap：IntelliJ IDEA Classic （经典配置在各个操作系统上比较一致）</li>
<li>推荐插件：Lombok</li>
</ul>
<p>开发习惯</p>
<p>需求开发</p>
<p>确认需求</p>
<ul>
<li>与产品经理确认需求背景，确认需求有效性。</li>
<li>向产品经理复述对需求的理解，以确保二者理解的一致性。</li>
<li>将需求开发挪到开发中（In Dev）。</li>
</ul>
<p>接口变更</p>
<ul>
<li><p>确认该需求是否需要接口变更（增加接口、增加接口字段等）。</p>
</li>
<li><p>若需要接口变更</p>
</li>
<li><ul>
<li>发起接口变更的审核，审核通过，方可继续开发。</li>
<li>（后端）将变更后的接口更新在接口文档中。</li>
<li>（前端）按照变更后接口更新模拟接口。</li>
</ul>
</li>
</ul>
<p>数据库变更</p>
<ul>
<li><p>确认该需求是否需要数据库变更（增加表、增加数据库字段等）。</p>
</li>
<li><p>若需要数据库变更</p>
</li>
<li><ul>
<li>发起数据库变更的审核，审核通过，方可继续开发。</li>
<li>（后端）将变更后的接口更新在数据库迁移中。</li>
</ul>
</li>
</ul>
<p>需求开发</p>
<ul>
<li>先对要开发的任务进行任务分解。参考 <strong>任务分解</strong> 一节。</li>
<li>按照任务进行开发。在代码编写的过程中，要及时<strong>格式化代码</strong>，尽可能<strong>消除 IDE 给出的警告</strong>。</li>
<li>每完成一个任务，提交一次代码。参考 <strong>代码提交</strong> 一节。</li>
<li>除了要编写基本的功能代码之外，编写代码的过程还要开发相应的 <strong>测试</strong>。</li>
<li>在所有任务完成之后，对照需求的 <strong>验收标准</strong>，确认代码满足了需求。</li>
</ul>
<p>需求验收</p>
<ul>
<li>将开发完成的需求演示给产品经理。</li>
<li>产品经理认为该需求已经达成需求的要求，满足验收标准，需求开发结束，否则，重新调整，满足需求。</li>
<li>将需求卡片挪到待测试（Ready for Test）。</li>
</ul>
<p>任务分解</p>
<ul>
<li><p>推荐在每天工作伊始，先将要完成的工作进行任务分解。</p>
</li>
<li><p>任务的粒度要求</p>
</li>
<li><ul>
<li><strong>足够小</strong>，大约可以在半个小时之内完成。</li>
<li><strong>完整</strong>，一个任务完成之后可以独立提交。</li>
</ul>
</li>
<li><p>在开发过程中，如果遇到新的任务，可以附加在任务列表上。</p>
</li>
<li><p>任务列表工具</p>
</li>
<li><ul>
<li>贴纸（物理），将贴纸贴到电脑显示器上。</li>
<li>stickies（App），Mac 自带的 App。配置为悬浮，在菜单中选择 Window -&gt; Float on Top。</li>
<li>其它 App，比如，微软 ToDo。</li>
</ul>
</li>
<li><p>下面是一个供参考的任务分解样例，完成了一个用户名密码登录的过程。</p>
</li>
<li><p>具体的分解过程请参考 <a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/78542">极客时间的《一起练习：手把手带你分解任务》</a></p>
</li>
</ul>
<p><img src="https://funstory.feishu.cn/space/api/box/stream/download/asynccode/?code=2eb606d6d4934a198c7585308580b268_8f118824ce50c961_boxcnzaVmRkva6OPSgL66H0k8kO_vAKUnzKkrlH0mLvnytWRaiJK6FQ7ERfh" alt="img"></p>
<p>版本控制</p>
<p>Git 的基本使用</p>
<ul>
<li>推荐使用 Git 作为版本控制工具</li>
<li>推荐使用 oh-my-zsh 的 Git 插件</li>
</ul>
<p>基本配置</p>
<p>全局的 Git 建议配置（在 ~/.gitconfig 中）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[alias]</span><br><span class="line"> co = checkout</span><br><span class="line"> st = status</span><br><span class="line"> ci = commit -a</span><br><span class="line">[color]</span><br><span class="line"> ui = auto</span><br></pre></td></tr></table></figure>

<p>基本使用</p>
<p>从远程更新代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gup # Git 插件命令 git pull --rebase</span><br></pre></td></tr></table></figure>

<p>向远程推送代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gp # Git 插件命令 git push</span><br></pre></td></tr></table></figure>

<p>查看修改结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git st # 使用 Git 全局配置别名</span><br><span class="line">gst # Git 插件命令 git status</span><br></pre></td></tr></table></figure>

<p>提交代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git ci -m&quot;This is commit message&quot;</span><br></pre></td></tr></table></figure>

<p>发布管理</p>
<ul>
<li>推荐采用无特性分支的 Git Flow，也就是说，<strong>不允许使用 feature 分支</strong>。</li>
</ul>
<p>分支介绍</p>
<table>
<thead>
<tr>
<th>分支</th>
<th>用途</th>
<th>提交/合并代码</th>
<th>远程分支</th>
<th>长期保持</th>
</tr>
</thead>
<tbody><tr>
<td>develop</td>
<td>用于日常的迭代开发</td>
<td>允许提交代码，允许由 release、hotfix 分支合并代码</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>master</td>
<td>保持与生产环境一致</td>
<td><strong>不允许</strong>提交代码，允许由 release、hotfix 分支合并代码</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>release</td>
<td>用于迭代发布</td>
<td>在迭代测试期间提交代码，<strong>不允许</strong>合并分支代码</td>
<td>可以</td>
<td>一般情况不长期保持；有特定版本，允许保留，</td>
</tr>
<tr>
<td>hotfix</td>
<td>用于修复线上问题</td>
<td>在修复问题期间提交代码，<strong>不允许</strong>合并分支代码</td>
<td>否</td>
<td>否</td>
</tr>
</tbody></table>
<p>基本用法</p>
<ul>
<li>初始化</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git flow init</span><br></pre></td></tr></table></figure>

<ul>
<li><p>发布（Release）</p>
</li>
<li><ul>
<li>发布开始</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git flow release start v20200901</span><br></pre></td></tr></table></figure>

<ul>
<li><ul>
<li>发布结束</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git flow release finish v20200901</span><br></pre></td></tr></table></figure>

<ul>
<li><p>修复问题（Hotfix）</p>
</li>
<li><ul>
<li>修复问题</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git flow hotfix start fix_production_bug</span><br></pre></td></tr></table></figure>

<ul>
<li><ul>
<li>发布结束</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git flow hotfix finish fix_production_bug</span><br></pre></td></tr></table></figure>

<p>代码提交</p>
<p>本地构建</p>
<p>提交代码之前，<strong>必须</strong>保证代码的本地构建是通过的。</p>
<p>确认提交</p>
<p>提交代码前，需要确认修改是自己要做的修改，防止误操作。</p>
<ul>
<li>确认修改文件：确定修改文件是自己要修改的文件，运行如下命令。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gst</span><br></pre></td></tr></table></figure>

<p>对于误修改的文件，运行如下命令恢复</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git co 文件路径</span><br></pre></td></tr></table></figure>

<ul>
<li><p>确认修改内容：</p>
</li>
<li><p>确定修改的内容是自己要修改的内容，确保代码<strong>正确地格式化</strong>，运行如下命令：</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gd</span><br></pre></td></tr></table></figure>

<p>提交代码</p>
<ul>
<li>加入新文件。将未加入版本管理的文件，加入版本管理</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add 文件路径</span><br></pre></td></tr></table></figure>

<ul>
<li>提交代码</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git ci -m&quot;This is your commit message&quot;</span><br></pre></td></tr></table></figure>

<p>注释</p>
<p>原则：注释有意义，准确描述出在做的事情。</p>
<ul>
<li>注释使用英文，首字母大写，首单词为动词。</li>
</ul>
<p>单一提交线</p>
<ul>
<li><p>本地提交后的代码不允许出现提交线分叉，若出现分叉，请使用 rebase。</p>
</li>
<li><p>可能出现分叉的场景</p>
</li>
<li><ul>
<li>从远程拉代码，建议使用 gup 命令，保证在拉代码的同时，进行 rebase。</li>
<li><strong>从 release/hotfix 分支合并代码，允许保留分叉</strong>。</li>
</ul>
</li>
</ul>
<p>获取远程代码</p>
<ul>
<li>获取远程代码。采用如下命令，获取远程代码，该命令在获取远程代码之后，进行 rebase 操作。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gup</span><br></pre></td></tr></table></figure>

<ul>
<li>修复冲突。如果在获取远程代码之后，产生了冲突，请先解决冲突。冲突解决之后，采用如下命令：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add 冲突文件路径</span><br></pre></td></tr></table></figure>

<p>在所有冲突解决之后，采用如下命令，继续完成 rebase 操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git rebase --continue # Git 插件别名：grbc</span><br></pre></td></tr></table></figure>

<ul>
<li>本地构建。在合并了远端代码之后，再次运行本地构建，确保合并之后的代码，依然可以通过本地构建。如有问题，请及时修复。</li>
</ul>
<p>推送代码</p>
<p>采用如下命令将代码推送至远程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gp</span><br></pre></td></tr></table></figure>

<p>监控持续集成</p>
<p>程序员需要等到持续集成通过之后，再进行后续开发。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/2022/09/14/%E4%B8%80%E4%B8%AAJava%E7%A8%8B%E5%BA%8F%E5%91%98%E7%9A%84%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AEmac%E7%AF%87/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
          <li class="pagination-next">
            <a
                class="btn btn--default btn--small"
                href="/archives/page/2/"
                aria-label="OLDER POSTS"
            >
              <span>OLDER POSTS</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">page 1 of 5</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Topsion. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Topsion</h4>
        
            <div id="about-card-bio"><p>Fullstack Developer</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Essex Lake Group</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Xi&#39;an China
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-cpvrqabbtrsz39nccx4gfwz836labdhgfnxcn8lmy5ueoerwy1aah9qj3roj.min.js"></script>

<!--SCRIPTS END-->





    </body>
</html>
